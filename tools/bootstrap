#!/bin/execlineb
multisubstitute {
    importas -ui ROOTDIR 1
    importas -ui ARCH 2
    importas -ui MIRROR 3
}
emptyenv -P

define -s APK "apk-tools/sbin/apk.static --root=${ROOTDIR} --arch=${ARCH}"

sudo
umask 0022

if {
    mkdir -p ${ROOTDIR}/etc/apk/keys
}

if {
    elglob KEYS .cache/keys/*.pub
    cp -a $KEYS ${ROOTDIR}/etc/apk/keys
}

if {
    redirfd -w 1 ${ROOTDIR}/etc/apk/repositories
    s6-echo ${MIRROR}/main
}

if { ln -s ../../var/cache/apk ${ROOTDIR}/etc/apk/cache }
if { $APK add --initdb }
if { $APK update }
if { $APK add alpine-baselayout apk-tools }
if { cp /etc/resolv.conf ${ROOTDIR}/etc/resolv.conf }

foreground {
    export PATH /bin:/usr/bin:/sbin:/usr/sbin
    chroot ${ROOTDIR}
    apk add
        alpine-baselayout apk-tools
        alpine-keys
        syslinux linux-grsec linux-virtgrsec
        e2fsprogs
        execline s6 s6-rc s6-portable-utils s6-linux-utils s6-linux-init
}
