#!/bin/execlineb
multisubstitute {
    importas -ui ROOTDIR 1
    importas -ui ARCH 2
    importas -ui MIRROR 3
}
emptyenv -P

define -s APK "apk-tools/sbin/apk.static --root=${ROOTDIR} --arch=${ARCH}"

sudo

if {
    mkdir -p ${ROOTDIR}/etc/apk/keys
}

if {
    elglob KEYS .cache/keys/*.pub
    cp -a $KEYS ${ROOTDIR}/etc/apk/keys
}

if {
    redirfd -w 1 ${ROOTDIR}/etc/apk/repositories
    s6-echo ${MIRROR}/main
}

if { $APK add --initdb }
if { $APK update }
if { $APK add alpine-baselayout apk-tools }

export PATH /bin:/usr/bin:/sbin:/usr/sbin
chroot ${ROOTDIR}
apk add
    alpine-keys alpine-baselayout apk-tools busybox
    syslinux linux-grsec linux-virtgrsec s6 s6-rc s6-linux-init e2fsprogs
