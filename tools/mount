#!/bin/execlineb -S2
sudo

backtick -ni LODEV { losetup -f --show -P $1 }
import -ui LODEV

ifte {
    exit 0
} {
    foreground { umount -R $2 }
    losetup -d $LODEV
}

if { mount ${LODEV}p2 ${2} }

if {
    cd ${2}
    mkdir -p boot dev sys proc media/cdrom opt etc bin sbin var tmp
}

if { mount ${LODEV}p1 ${2}/boot }
if { mount -o bind /dev ${2}/dev }
if { mount -o bind /proc ${2}/proc }
if { mount -o bind /sys ${2}/sys }
mount -t tmpfs tmpfs ${2}/tmp
