#!/bin/execlineb
multisubstitute {
    importas -ui IMGFILE 1
    importas -ui ROOTDIR 2
}
emptyenv -P

sudo

backtick -ni LODEV { losetup -f --show -P $IMGFILE }
import -ui LODEV

ifte {
    exit 0
} {
    foreground { umount -R $ROOTDIR }
    foreground { losetup -d $LODEV }
    foreground { rm -f ${ROOTDIR}/.mounted }
    touch ${ROOTDIR}/.unmounted
}

if { mount ${LODEV}p2 ${ROOTDIR} }

if {
    cd ${ROOTDIR}
    mkdir -p boot dev sys proc media/cdrom opt etc bin sbin usr/bin usr/sbin var tmp
}

if { mount ${LODEV}p1 ${ROOTDIR}/boot }
if { mount -o bind /dev ${ROOTDIR}/dev }
if { mount -o bind /proc ${ROOTDIR}/proc }
if { mount -o bind /sys ${ROOTDIR}/sys }
mount -t tmpfs tmpfs ${ROOTDIR}/tmp

foreground { rm -f ${ROOTDIR}/.unmounted }
touch ${ROOTDIR}/.mounted
